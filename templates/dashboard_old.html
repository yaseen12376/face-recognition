










<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Faculty Dashboard | Smart Attendance System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<style>
:root {
    --primary-color: #0d6efd;
    --secondary-color: #6c757d;
    --light-gray: #f8f9fa;
    --body-bg: #f4f7fb;
    --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    --card-radius: 0.5rem;
}
body { 
    background: var(--body-bg); 
    font-family: 'Inter', sans-serif; /* You might want to add a Google Fonts link for 'Inter' */
}
/* Navbar */
.navbar { 
    box-shadow: 0 2px 4px rgba(0,0,0,0.04); 
}
.navbar-brand { font-weight: 600; }
/* Sidebar */
.sidebar { 
    min-width: 240px; 
    max-width: 240px; 
    background: #fff; 
    min-height: calc(100vh - 57px);
    box-shadow: 2px 0 6px rgba(0,0,0,0.05);
}
.sidebar .nav-link {
    color: #555;
    font-weight: 500;
    padding: .75rem 1rem;
    border-radius: 6px;
    margin-bottom: 0.25rem;
    transition: all 0.2s ease-in-out;
    cursor: pointer;
}
.sidebar .nav-link i { margin-right: 12px; width: 20px; text-align: center; }
.sidebar .nav-link:hover { 
    background: var(--light-gray); 
    color: var(--primary-color); 
}
.sidebar .nav-link.active { 
    background: var(--primary-color); 
    color: #fff; 
}
/* Content */
.content-area { 
    padding: 1.5rem; 
    width: calc(100% - 240px); 
}
.card {
    border: none;
    border-radius: var(--card-radius);
    box-shadow: var(--card-shadow);
    margin-bottom: 1.5rem;
}
.stat-card .card-body { display: flex; align-items: center; }
.stat-card .icon-circle {
    width: 45px; height: 45px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin-right: 1rem; font-size: 1.2rem; color: #fff;
}
.stat-card h5 { font-size: 1.5rem; font-weight: 700; }
/* Camera Section */
video { 
    width: 100%; height: auto; 
    border-radius: var(--card-radius); 
    background: #e9ecef; 
}
canvas { display: none; }
#snapshotImg { 
    max-width:100%; 
    border:1px solid #dee2e6; 
    border-radius: var(--card-radius); 
    margin-top: 1rem; 
}
#processingStatus { 
    font-style: italic; 
    color: var(--secondary-color); 
    min-height: 24px; 
}
</style>
</head>
<body>
<nav class="navbar navbar-light bg-white">
    <div class="container-fluid">
        <a class="navbar-brand"><i class="fa-solid fa-clipboard-user me-2 text-primary"></i>Smart Attendance</a>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
            <i class="fa-solid fa-arrow-right-from-bracket me-1"></i> Logout
        </button>
    </div>
</nav>

<div class="d-flex">
    <aside class="sidebar p-3">
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" data-view="dashboardView"><i class="fa-solid fa-table-columns"></i> Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" data-view="attendanceView"><i class="fa-solid fa-calendar-check"></i> Attendance</a></li>
            <li class="nav-item"><a class="nav-link" data-view="reportsView"><i class="fa-solid fa-chart-pie"></i> Reports</a></li>
            <li class="nav-item"><a class="nav-link" data-view="studentsView"><i class="fa-solid fa-users"></i> Students</a></li>
            <li class="nav-item"><a class="nav-link" data-view="settingsView"><i class="fa-solid fa-gear"></i> Settings</a></li>
        </ul>
    </aside>
    <main class="content-area">
        
        <div id="dashboardView">
            <h4>Welcome, Professor Anya</h4>
            <p class="text-muted mb-4">Hereâ€™s your summary for today's class: CSE-B (Data Structures) - $current_date$.</p>
            <div class="row">
                <div class="col-md-4"><div class="card stat-card"><div class="card-body"><div class="icon-circle bg-success"><i class="fa-solid fa-user-check"></i></div><div><h5>54</h5><p class="text-muted mb-0">Present Today</p></div></div></div></div>
                <div class="col-md-4"><div class="card stat-card"><div class="card-body"><div class="icon-circle bg-danger"><i class="fa-solid fa-user-xmark"></i></div><div><h5>6</h5><p class="text-muted mb-0">Absentees</p></div></div></div></div>
                <div class="col-md-4"><div class="card stat-card"><div class="card-body"><div class="icon-circle bg-warning text-dark"><i class="fa-solid fa-user-clock"></i></div><div><h5>2</h5><p class="text-muted mb-0">Late Entries</p></div></div></div></div>
            </div>
            <div class="row">
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Live Attendance Log</h5>
                            <p class="card-subtitle text-muted mb-3">Recent entries will appear here automatically.</p>
                            <div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>Student Name</th><th>ID</th><th>Time</th><th>Status</th></tr></thead><tbody id="attendanceLog"><tr><td colspan="4" class="text-center text-muted">No entries yet...</td></tr></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div id="cameraSection" class="card">
                        <div class="card-body">
                            <h5 class="card-title">Attendance Capture</h5>
                            <video id="video" autoplay playsinline></video><canvas id="canvas"></canvas>
                            <div class="mt-3 d-flex gap-2"><button class="btn btn-primary w-100" id="captureBtn"><i class="fa-solid fa-camera-retro me-2"></i> Capture & Mark Attendance</button><button class="btn btn-outline-secondary" id="toggleStreamBtn" title="Toggle Camera"><i class="fa-solid fa-power-off"></i></button></div>
                            <div id="processingStatus" class="mt-2 text-center"></div><img id="snapshotImg">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="attendanceView" style="display: none;">
            <h4>Full Attendance Record</h4>
            <p class="text-muted mb-4">View and manage historical attendance data for CSE-B.</p>
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Attendance History</h5>
                        <button class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-file-export me-2"></i>Export as CSV</button>
                    </div>
                    <p class="text-muted">Showing all records for the semester.</p>
                    <table class="table table-striped">
                        <thead class="table-light"><tr><th>Date</th><th>Student Name</th><th>ID</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody>
                            <tr><td>2025-09-14</td><td>John Doe</td><td>101</td><td><span class="badge bg-success">Present</span></td><td><button class="btn btn-sm btn-outline-secondary">Details</button></td></tr>
                            <tr><td>2025-09-14</td><td>Jane Smith</td><td>102</td><td><span class="badge bg-danger">Absent</span></td><td><button class="btn btn-sm btn-outline-secondary">Details</button></td></tr>
                            <tr><td>2025-09-13</td><td>Peter Jones</td><td>103</td><td><span class="badge bg-warning text-dark">Late</span></td><td><button class="btn btn-sm btn-outline-secondary">Details</button></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="reportsView" style="display: none;">
            <h4>Analytics & Reports</h4>
            <p class="text-muted mb-4">Visualize attendance trends and generate reports.</p>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Attendance Trends</h5>
                    <p class="text-muted">Placeholder for charts and graphs.</p>
                    <div class="text-center p-5 border rounded bg-light">
                        <i class="fa-solid fa-chart-line fa-3x text-primary"></i>
                        <p class="mt-3">Chart data will be displayed here.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="studentsView" style="display: none;">
            <h4>Student Management</h4>
            <p class="text-muted mb-4">Manage student roster for your classes.</p>
             <div class="card">
                <div class="card-body">
                    <h5 class="card-title">CSE-B Roster</h5>
                     <table class="table table-hover">
                        <thead class="table-light"><tr><th>Student Name</th><th>ID</th><th>Email</th><th>Overall Attendance</th></tr></thead>
                        <tbody>
                            <tr><td>John Doe</td><td>101</td><td>john.doe@example.com</td><td>95%</td></tr>
                            <tr><td>Jane Smith</td><td>102</td><td>jane.smith@example.com</td><td>92%</td></tr>
                            <tr><td>Peter Jones</td><td>103</td><td>peter.jones@example.com</td><td>88%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settingsView" style="display: none;">
            <h4>Settings</h4>
            <p class="text-muted mb-4">Configure your application preferences.</p>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">System Configuration</h5>
                    <form>
                        <div class="mb-3"><label class="form-label">Default Camera</label><select class="form-select"><option>Front Facing Camera</option><option>Rear Facing Camera</option></select></div>
                        <div class="mb-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="emailNotifications" checked><label class="form-check-label" for="emailNotifications">Enable Email Notifications for Low Attendance</label></div></div>
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </form>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Camera and Dashboard Logic ---
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const snapshotImg = document.getElementById("snapshotImg");
    const captureBtn = document.getElementById("captureBtn");
    const toggleStreamBtn = document.getElementById("toggleStreamBtn");
    const attendanceLog = document.getElementById("attendanceLog");
    const processingStatus = document.getElementById("processingStatus");
    let currentStream = null;
    const students = [
        { id: '101', name: 'John Doe' }, { id: '102', name: 'Jane Smith' },
        { id: '103', name: 'Peter Jones' }, { id: '104', name: 'Mary Williams' },
        { id: '105', name: 'David Brown' }
    ];
    let hasLogged = false;

    async function startStream() {
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = currentStream;
            toggleStreamBtn.innerHTML = '<i class="fa-solid fa-power-off"></i>';
            captureBtn.disabled = false;
        } catch (err) {
            alert("Error: Could not access the camera. Please grant permission and try again.");
        }
    }

    function stopStream() {
        if (currentStream) {
            currentStream.getTracks().forEach(t => t.stop());
            video.srcObject = null;
            toggleStreamBtn.innerHTML = '<i class="fa-solid fa-video"></i>';
            captureBtn.disabled = true;
        }
    }

    if (captureBtn) {
        captureBtn.addEventListener("click", async () => {
            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext("2d").drawImage(video, 0, 0);
                const imageDataUrl = canvas.toDataURL("image/png");
                snapshotImg.src = imageDataUrl;
                snapshotImg.style.display = "block";
                processingStatus.innerHTML = `Processing... <i class="fa-solid fa-brain fa-spin"></i>`;
                captureBtn.disabled = true;

                // Send image to backend for recognition
                const formData = new FormData();
                formData.append('image_data', imageDataUrl);

                const response = await fetch('/capture-attendance', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success && result.attendance_records.length > 0) {
                    const student = result.attendance_records[0];
                    processingStatus.innerHTML = `<span class="text-success">Success! ${student.name} identified.</span>`;
                    addAttendanceRecord(student.name, student.rrn, "Present");
                } else {
                    processingStatus.innerHTML = `<span class="text-danger">No faces recognized. Please try again.</span>`;
                    addAttendanceRecord("Unknown Student", "N/A", "Unrecognized");
                }
            } catch (error) {
                console.error('Error:', error);
                processingStatus.innerHTML = `<span class="text-danger">Error processing image. Please try again.</span>`;
            } finally {
                captureBtn.disabled = false;
            }
        });
    }

    if (toggleStreamBtn) {
        toggleStreamBtn.addEventListener("click", () => {
            if (video.srcObject) stopStream(); else startStream();
        });
    }
    
    function addAttendanceRecord(name, id, status) {
        if (!hasLogged) {
            attendanceLog.innerHTML = '';
            hasLogged = true;
        }
        const newRow = document.createElement('tr');
        const statusClass = status === 'Present' ? 'bg-success' : 'bg-danger';
        newRow.innerHTML = `<td>${name}</td><td>${id}</td><td>${new Date().toLocaleTimeString()}</td><td><span class="badge ${statusClass}">${status}</span></td>`;
        attendanceLog.prepend(newRow);
    }

    window.logout = function() {
        fetch('/logout', { method: 'POST' })
            .then(() => {
                window.location.href = "/login";
            })
            .catch((error) => {
                console.error('Error:', error);
                window.location.href = "/login";
            });
    }
    
    // --- Navigation Logic ---
    const navLinks = document.querySelectorAll('.sidebar .nav-link');
    const contentViews = document.querySelectorAll('.content-area > div');

    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            const viewId = link.getAttribute('data-view');

            // Update active class on links
            navLinks.forEach(nav => nav.classList.remove('active'));
            link.classList.add('active');

            // Show the correct view and hide others
            contentViews.forEach(view => {
                view.style.display = view.id === viewId ? 'block' : 'none';
            });
            
            // Special handling for dashboard camera
            if (viewId === 'dashboardView') {
                if (!video.srcObject) { startStream(); }
            } else {
                if (video.srcObject) { stopStream(); }
            }
        });
    });

    // Start camera only when on the dashboard initially
    startStream();
});
</script>
</body>
</html>